version: "1"

services:
  - type: web
    name: mi-backend-spring
    env: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    plan: free
    autoDeploy: true
    envVars:
      # Perfil activo
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      
      # URL COMPLETA DE CONEXIÓN (Render la genera automáticamente)
      - key: SPRING_DATASOURCE_URL
        fromService:
          type: pserv  # ¡IMPORTANTE! Para MySQL usamos "pserv", no "mysql" o "database"
          name: mi-mysql-db
          property: connectionString
      
      # Usuario y contraseña (también desde la conexión)
      - key: SPRING_DATASOURCE_USERNAME
        fromService:
          type: pserv
          name: mi-mysql-db
          property: username

      - key: SPRING_DATASOURCE_PASSWORD
        fromService:
          type: pserv
          name: mi-mysql-db
          property: password
      
      # JWT
      - key: JWT_SECRET
        generateValue: true
      
      # Variables adicionales si las necesitas (opcional)
      - key: MYSQL_HOST
        fromService:
          type: pserv
          name: mi-mysql-db
          property: host

      - key: MYSQL_PORT
        fromService:
          type: pserv
          name: mi-mysql-db
          property: port

      - key: MYSQL_DATABASE
        fromService:
          type: pserv
          name: mi-mysql-db
          property: database

      - key: MYSQL_USER
        fromService:
          type: pserv
          name: mi-mysql-db
          property: username

      - key: MYSQL_PASSWORD
        fromService:
          type: pserv
          name: mi-mysql-db
          property: password
    
    healthCheckPath: /actuator/health
    initialDelay: 180

databases:
  - name: mi-mysql-db
    databaseName: mi_app_db
    plan: free
    ipAllowList:
      - source: render